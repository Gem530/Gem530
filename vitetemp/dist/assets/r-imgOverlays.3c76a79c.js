import{d as H,r as re,a as h,n as ce,l as V,o as k,e as y,m as i,u as _,B,O as ue,C as F,F as $,v as j,x as z,y as A,z as ve,f as me,D as pe}from"./@vue.fb42abb7.js";import{f as g}from"./fabric.310a32ce.js";import{_ as fe}from"./plugin-vue_export-helper.21dcd24c.js";import"./axios.e7b69eb3.js";const de=["width","height"],he=["src"],ge={class:"flex"},be=["max","step"],we={class:"flex"},ke=["onClick"],ye={class:"flex"},Ce=["onClick"],Me={class:"flex"},_e=H({props:{width:{type:Number,default:500},height:{type:Number,default:500},maxScale:{type:Number,default:3},scaleStep:{type:Number,default:.01},img:{type:String,default:"https://img1.baidu.com/it/u=2644452384,3800439215&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500"},colors:{type:Array,default:()=>["pink","skyblue","orange"]},isImgWH:{type:Boolean,default:!1},graphical:{type:Array,default:()=>[{key:"Rect",name:"\u77E9\u5F62"},{key:"RectR",name:"\u5706\u89D2\u77E9\u5F62"},{key:"Circle",name:"\u5706"},{key:"Ellipse",name:"\u692D\u5706"},{key:"Triangle",name:"\u4E09\u89D2\u5F62"},{key:"Line",name:"\u7EBF\u6BB5"},{key:"IText",name:"\u6587\u5B57"}]}},emits:["getImg"],setup(E,{emit:Y}){var R;const l=E,m=re({isMove:!1,isCreateObject:!0,isStroke:!1,isOperat:!1});let e=null,n=null;const I=h(),r=h(null),x=h(void 0),L=h(l.img),p=h(1),T=h(0),P=h(0),N=h(1);let v=l.width,f=l.height;const C=h(l.colors[0]),M=h((R=l.graphical[0])==null?void 0:R.key);ce(()=>{T.value=I.value.getBoundingClientRect().top,P.value=I.value.getBoundingClientRect().left}),V(async()=>{if(l.isImgWH){const{w:t,h:a}=await U();v=t,f=a}W()});const U=()=>new Promise((t,a)=>{let o=new Image;o.src=l.img,o.crossOrigin="anonymous",o.onload=()=>{t({w:o.width,h:o.height})},o.onerror=s=>{a(s)}}),S=t=>{e.selection=!1;for(let a in m)m[a]=a==t;t==="isStroke"&&(m.isCreateObject=!0),t==="isOperat"&&(e.getObjects().forEach(o=>{o.selectable=!0}),e.selection=!0,e.setViewportTransform(e.viewportTransform))},G=()=>{e.getActiveObjects().forEach(a=>{e.remove(a)})},W=async()=>{e=new g.fabric.Canvas("canvasDom",{width:v,height:f}),e.lastzoomPointX=v/2,e.lastzoomPointY=f/2,e.relativeX=0,e.relativeY=0;const t=await se();ae(),oe(),e.setBackgroundImage(t),e.renderAll(),e.selection=!1,e.selectionFullyContained=!0,q()},q=()=>{e.on({"mouse:up":t=>ee(t),"mouse:move":t=>Q(t),"mouse:down":t=>K(t),"mouse:wheel":t=>Z(t)})},J=()=>{O("init",v/2,f/2)},X=t=>{O(t,v/2,f/2)},Z=({e:t})=>{const a=t.deltaY<0?"+":"-";t.preventDefault(),t.stopPropagation(),O(a,t.pageX-P.value,t.pageY-T.value)},K=({e:t})=>{if(t.preventDefault(),t.stopPropagation(),e.isDragging=!0,e.lastPosX=t.clientX,e.lastPosY=t.clientY,m.isCreateObject){const{top:a,left:o}=D(t);switch(M.value){case"Rect":n=new g.fabric.Rect,e.add(n);break;case"RectR":n=new g.fabric.Rect,e.add(n);break;case"Circle":n=new g.fabric.Circle,e.add(n);break;case"Ellipse":n=new g.fabric.Ellipse,e.add(n);break;case"Triangle":n=new g.fabric.Triangle({width:0,height:0,top:a,left:o}),e.add(n);break;case"IText":n=new g.fabric.IText("\u8BF7\u8F93\u5165\u3002\u3002",{top:a,left:o}),e.add(n);break}}},Q=({e:t})=>{if(t.preventDefault(),t.stopPropagation(),e.isDragging){if(m.isMove){let a=e.viewportTransform;a[4]+=t.clientX-e.lastPosX,a[5]+=t.clientY-e.lastPosY,e.requestRenderAll(),e.lastPosX=t.clientX,e.lastPosY=t.clientY,e.relativeX=a[4],e.relativeY=a[5],e.setViewportTransform(e.viewportTransform)}if(m.isCreateObject){const{top:a,left:o,w:s,h:u,right:c,bottom:d}=D(t),b=m.isStroke?"":C.value,w=m.isStroke?C.value:"";switch(M.value){case"Rect":n.set({width:Math.abs(o-c),height:Math.abs(a-d),fill:b,stroke:w,top:Math.min(a,d),left:Math.min(o,c)});break;case"RectR":n.set({width:Math.abs(o-c),height:Math.abs(a-d),fill:b,stroke:w,top:Math.min(a,d),left:Math.min(o,c),rx:5,ry:5});break;case"Circle":n.set({radius:Math.abs(s/2),fill:b,stroke:w,top:Math.min(a,d),left:Math.min(o,c)});break;case"Ellipse":n.set({rx:Math.abs(s/2),ry:Math.abs(u/2),fill:b,stroke:w,top:Math.min(a,d),left:Math.min(o,c)});break;case"Triangle":n.set({width:Math.abs(o-c),height:Math.abs(a-d),fill:b,stroke:w,top:Math.min(a,d),left:Math.min(o,c)});break}e.renderAll(),e.setViewportTransform(e.viewportTransform)}}},ee=({e:t})=>{if(t.preventDefault(),t.stopPropagation(),e.isDragging=!1,m.isCreateObject){const{top:a,left:o,right:s,bottom:u}=D(t);switch(M.value){case"Line":n=new g.fabric.Line([o,a,s,u],{stroke:C.value}),e.add(n);break;case"IText":e.renderAll();break}n.selectable=!1}},D=t=>{const a=(t.clientX-e.lastPosX)/p.value,o=(t.clientY-e.lastPosY)/p.value,s=e.relativeX>0?e.relativeX*2:0,u=e.relativeY>0?e.relativeY*2:0,c=(t.clientX-P.value+Math.abs(e.viewportTransform[4])-s)/p.value,d=(t.clientY-T.value+Math.abs(e.viewportTransform[5])-u)/p.value,b=(e.lastPosY-T.value+Math.abs(e.viewportTransform[5])-u)/p.value,w=(e.lastPosX-P.value+Math.abs(e.viewportTransform[4])-s)/p.value;return{relaX:s,relaY:u,top:b,left:w,w:a,h:o,right:c,bottom:d}},te=t=>{M.value=t.key},ae=()=>{r.value.top=f/2,r.value.left=v/2,r.value.originX="center",r.value.originY="center",r.value.selectable=!1,r.value.cornerStyle="circle",r.value.rotate(0)},O=(t,a,o)=>{let s;if(t=="change")s=p.value;else if(t=="init"){s=1,e.relativeX=0,e.relativeY=0;const c=[1,0,0,1,0,0];e.setViewportTransform(c)}else s=(t=="-"?-l.scaleStep:l.scaleStep)+e.getZoom();s=Math.max(1,s),s=Math.min(l.maxScale,s),e.lastzoomPointX=a,e.lastzoomPointY=o;const u=new g.fabric.Point(a,o);e.relativeX=e.viewportTransform[4]/s,e.relativeY=e.viewportTransform[5]/s,e.zoomToPoint(u,s),e.setViewportTransform(e.viewportTransform),p.value=s},oe=()=>{const t=r.value.width>v?v/r.value.width:r.value.width/v,a=r.value.height>f?f/r.value.height:r.value.height/v,o=t<=a?t:a;r.value.scaleX=o,r.value.scaleY=o,N.value=o},se=()=>new Promise((t,a)=>{g.fabric.Image.fromURL(L.value,o=>{r.value=o,t(o)},{crossOrigin:"anonymous"})}),ne=(t=1,a="png")=>e.toDataURL({top:0,left:0,width:v,height:f,format:a,quality:t}),le=()=>{x.value=ne();const t=ie(x.value);Y("getImg",{url:x.value,blob:t})},ie=t=>{for(var a=t.split(","),o=a[0].match(/:(.*?);/)[1],s=atob(a[1]),u=s.length,c=new Uint8Array(u);u--;)c[u]=s.charCodeAt(u);return new Blob([c],{type:o})};return(t,a)=>(k(),y("div",{class:"component theme",style:z(`width: ${_(v)}px;`)},[i("canvas",{id:"canvasDom",ref_key:"myCanvas",ref:I,width:_(v),height:_(f)},null,8,de),i("img",{src:x.value,alt:""},null,8,he),i("div",ge,[i("button",{onClick:a[0]||(a[0]=o=>X("-"))},"-"),B(i("input",{type:"range","onUpdate:modelValue":a[1]||(a[1]=o=>p.value=o),min:1,max:l.maxScale,step:l.scaleStep,onInput:a[2]||(a[2]=o=>X("change"))},null,40,be),[[ue,p.value]]),i("button",{onClick:a[3]||(a[3]=o=>X("+"))},"+"),i("button",{onClick:J},"\u8FD8\u539F"),i("button",{onClick:le},"\u88C1\u526A"),B(i("div",null,[i("div",we,[(k(!0),y($,null,j(l.colors,o=>(k(),y("div",{key:o,style:z(`background: ${o};`),class:A({"flex-item":!0,"active-flex":o==C.value}),onClick:s=>C.value=o},null,14,ke))),128))]),i("div",ye,[(k(!0),y($,null,j(l.graphical,o=>(k(),y("div",{key:o.key,class:A({"flex-item":!0,"active-flex":o.key==M.value}),onClick:s=>te(o)},ve(o.name),11,Ce))),128))])],512),[[F,_(m).isCreateObject]]),i("div",Me,[i("button",{onClick:a[4]||(a[4]=o=>S("isMove"))},"\u79FB\u52A8"),i("button",{onClick:a[5]||(a[5]=o=>S("isCreateObject"))},"\u7ED8\u5236"),i("button",{onClick:a[6]||(a[6]=o=>S("isStroke"))},"\u6846"),i("button",{onClick:a[7]||(a[7]=o=>S("isOperat"))},"\u64CD\u4F5C"),B(i("button",{onClick:G},"\u5220\u9664",512),[[F,_(m).isOperat]])])])],4))}});var xe=fe(_e,[["__scopeId","data-v-4d07402e"]]);const Te={class:"contanir component theme"},Pe=pe(" \u56FE\u7247\u6807\u6CE8\u9875\u9762 "),De=H({setup(E){V(()=>{});const Y=l=>{console.log(l)};return(l,m)=>(k(),y("div",Te,[Pe,me(xe,{width:300,height:300,onGetImg:Y})]))}});export{De as default};
